# ?? SSE Authentication Implementation

## ????? ?????????

????????? ????????? Basic Authentication ??? SSE (Server-Sent Events) fallback ??????, ??? ????????? ??????? ???????? ? ?????????? ???????? ??? ??? ???? `guest`, ??? ? ??? ???? `admin`.

## ????????? ?? ???????

### 1. ApiClient.cs - HTTP API Authentication

**?????????:**
- ????? `UpdateAuthHeaders()` ??? ????????? Basic Auth ??????????
- ?????????????? ?????????? `Authorization: Basic <credentials>` ??? ???? HTTP ????????
- ????????? ?????? 401 (Unauthorized) ? 403 (Forbidden)
- ????????????? ??????? ?????? ?? `AppSettings.MqttUsername` ? `AppSettings.MqttPassword`

**?????? ?????????????:**
```csharp
// Credentials ??????????????? ??? ??????
AppSettings.MqttUsername = "guest";
AppSettings.MqttPassword = "123";

// ApiClient ????????????? ????????? ?????????
var metrics = await apiClient.GetMetricsAsync();
// Request header: Authorization: Basic Z3Vlc3Q6MTIz
```

### 2. SseService.cs - SSE Stream Authentication

**?????????:**
- Basic Authentication ????????? ??? SSE ??????????? `/api/events/stream`
- ????????? ?????? 401/403 ? ?????????????? ????????????????
- ??????????? ??????? ??????????????
- ????????????? ????????? ?? ??????? ???????????

**?????? ???????????:**
```csharp
// SSE Service ????????????? ?????????? credentials ?? AppSettings
await sseService.StartAsync();
// Sends: GET /api/events/stream
// Header: Authorization: Basic YWRtaW46YWRtaW4xMjM=
```

## ?????????????? ????

### ?? Guest (guest:123)
- **??????????:** Read-only ??????
- **API endpoints:**
  - ? `GET /api/metrics` - ????????? ??????
  - ? `GET /api/devices` - ???????? ?????????
  - ? `GET /api/events/stream` - SSE ????? (real-time updates)
  - ? `POST /api/devices/{id}/toggle` - **403 Forbidden**

### ?? Admin (admin:admin123)
- **??????????:** ?????? ??????
- **API endpoints:**
  - ? `GET /api/metrics` - ????????? ??????
  - ? `GET /api/devices` - ???????? ?????????
  - ? `GET /api/events/stream` - SSE ????? (real-time updates)
  - ? `POST /api/devices/{id}/toggle` - **?????????? ????????????**

## ????????? ????????????

### ?????????? ????????? (FastAPI)

```bash
# Guest credentials (read-only)
export GUEST_PASSWORD="123"

# Admin credentials (full access)
export ADMIN_PASSWORD="admin123"
```

### ?????? ?????????? ???? (FastAPI)

```python
from fastapi.security import HTTPBasic, HTTPBasicCredentials

security = HTTPBasic()

SSE_USERS = {
    "guest": {
        "password": os.getenv("GUEST_PASSWORD", "123"),
        "role": "guest",
        "can_control": False  # Read-only
    },
    "admin": {
        "password": os.getenv("ADMIN_PASSWORD", "admin123"),
        "role": "admin",
        "can_control": True  # Full access
    }
}

def authenticate_sse_user(credentials: HTTPBasicCredentials = Depends(security)):
    # Validate username and password
    # Return user info with role and permissions
    ...
```

## ????????????

### ???? 1: Guest Login (Read-only)

```bash
# ????????? ??????
python main.py

# ????????? ??????
# Login: guest / 123
# Expected:
# - ? Connection: Connected (SSE)
# - ? Metrics updates
# - ? Device list visible
# - ? Toggle device -> "User 'guest' with role 'guest' cannot control devices"
```

### ???? 2: Admin Login (Full access)

```bash
# Login: admin / admin123
# Expected:
# - ? Connection: Connected (SSE)
# - ? Metrics updates
# - ? Device list visible
# - ? Toggle device -> Success
```

### ???? 3: Invalid Credentials

```bash
# Login: invalid / invalid
# Expected:
# - ? "127.0.0.1:8000 - GET /api/metrics HTTP/1.1 401 Unauthorized"
# - ? SSE: "Unauthorized - Check credentials"
# - ? Login failed with error message
```

## ???????

### ???????? ????? ? Visual Studio

**Debug ? Windows ? Output** (select "Debug")

```
SseService: Using Basic Auth for user 'guest'
SseService: Connected
ApiClient: Basic Auth configured for user 'guest'
```

### Curl ????????????

```bash
# ???? SSE endpoint
curl -u guest:123 -N http://127.0.0.1:8000/api/events/stream

# ???? ??????
curl -u admin:admin123 http://127.0.0.1:8000/api/metrics

# ???? toggle (admin)
curl -u admin:admin123 -X POST http://127.0.0.1:8000/api/devices/lamp/toggle

# ???? toggle (guest - should fail)
curl -u guest:123 -X POST http://127.0.0.1:8000/api/devices/lamp/toggle
# Expected: 403 Forbidden
```

## ????????????

### ?? ?????? ?????????

1. **Basic Auth ????? HTTPS**: ? production ?????? ??????????? HTTPS ??? ?????? credentials
2. **??????? ??????**: ???????? ????????? ?????? ? production
3. **Rate Limiting**: ???????? rate limiting ??? ?????? ?? brute-force ????
4. **JWT Tokens**: ??? production ????????????? ???????????? JWT ?????? Basic Auth

### Production Recommendations

```python
# 1. ??????????? ?????????? ?????????
GUEST_PASSWORD = os.getenv("GUEST_PASSWORD")  # Required in production
ADMIN_PASSWORD = os.getenv("ADMIN_PASSWORD")  # Required in production

# 2. ???????? ??????????? ???????
from passlib.context import CryptContext
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# 3. ??????????? HTTPS
# uvicorn main:app --ssl-keyfile key.pem --ssl-certfile cert.pem

# 4. Rate limiting
from slowapi import Limiter
limiter = Limiter(key_func=get_remote_address)
```

## ?????????????

| Client Version | Server Version | Status |
|---------------|---------------|--------|
| v1.0 (??? auth) | v1.0 (??? auth) | ? Work |
| v2.0 (? auth) | v1.0 (??? auth) | ?? Fails (401) |
| v2.0 (? auth) | v2.0 (? auth) | ? Work |
| v1.0 (??? auth) | v2.0 (? auth) | ? Fails (401) |

**?????:** ?????? ? ?????? ?????? ???? ????????? ????????????.

## Troubleshooting

### ??????: 401 Unauthorized

**???????:** ???????? ??????? ?????? ??? ?????? ?? ??????? ????????? ???????????

**???????:**
1. ????????? credentials ? `AppSettings`
2. ?????????, ??? ?????? ??????? ? ??????????? ??????????? ?????????
3. ????????? ???? ???????: `python main.py`

### ??????: 403 Forbidden

**???????:** Guest ???????? ????????? ????????, ????????? admin ????

**???????:**
- ??????? ??? admin ??? ?????????? ????????????
- ??? ???????? ???? ???????????? ?? ???????

### SSE ?? ????????????

**???????:** MQTT username/password ?? ???????????

**???????:**
```csharp
// ?????????, ??? credentials ??????????? ????? ???????? SSE
AppSettings.MqttUsername = "guest";
AppSettings.MqttPassword = "123";
await _realtimeService.StartAsync();
```

## Changelog

### v2.0 - SSE Authentication
- ? ????????? Basic Authentication ??? HTTP API
- ? ????????? Basic Authentication ??? SSE stream
- ? ????????? ????? guest/admin
- ? ????????? ?????? 401/403
- ? ?????????????? ??????????????? ??? ??????? ???????????

---

**????:** 2025-01-XX  
**?????:** SmartHome2 Team  
**??????:** 2.0
