# ?? SmartHome2 - Fallback Mode Implementation Guide

## ?? ????????

?? ??????? ??????????? **fallback ???????** ??? SmartHome2, ??????? ????????? ?????????? ???????? ???? ??? Mosquitto ???????!

---

## ??? ???????????

```
User tries to connect
    ?
Check server status: GET /api/status
    ?
        ?? MQTT available? YES ? MQTT Mode (Primary)
        ?                      • Port 8883
        ?                      • Username/Password auth
        ?                      • Full R/W access
        ?                      • ~10ms latency
        ?
        ?? MQTT available? NO ? SSE Mode (Fallback)
                              • HTTP GET /api/events/stream
                              • No auth needed (Guest)
                              • Read-only access
                              • ~100ms latency
```

---

## ?? ??? ???? ???????????

### ?? ??????? MAUI ???????:

1. **`SseService.cs`** - Server-Sent Events ??????
   - ???????????? ? `/api/events/stream`
   - ?????? SSE ???????
   - ???????? `MetricsReceived` ? `DeviceStateReceived`

2. **`RealtimeService.cs`** - Unified ?????? ? auto-fallback
   - ????????? ??????????? ???????
   - ???????? MQTT ??? SSE ?????????????
   - ????????????? ?? SSE ???? MQTT ????
   - ?????? API ??? ????? ???????

3. **?????????:**
   - `DashboardVm.cs` - ?????????? `IRealtimeService`
   - `DashboardPage.xaml` - ?????????? ??????? ?????
   - `MauiProgram.cs` - DI ??????????? ????????
   - `IApiClient.cs` & `ApiClient.cs` - ???????? `GetAsync<T>`

---

## ??? ????????? ????????? ??????? FastAPI

### ???????????? endpoints:

```python
# 1. Status endpoint - ??? ???????? MQTT ???????????
@app.get("/api/status")
async def get_status():
    return {
        "mqtt_available": mqtt_connected,
        "mqtt_broker": MQTT_BROKER,
        "mqtt_port": MQTT_PORT,
        "recommended_mode": "mqtt" if mqtt_connected else "sse",
        "sse_clients_count": len(sse_clients),
        "timestamp": datetime.now().isoformat()
    }

# 2. SSE Stream endpoint - ??? fallback ??????
@app.get("/api/events/stream")
async def event_stream(request: Request):
    # ?????????? ?? ?????? test_websocket_client.py
    # ?????? ?????????? ??????? ? ???????: data: {...}\n\n
    pass

# 3. Broadcast ??????? - ??? ???????? ? SSE ????????
async def broadcast_to_sse_clients(topic: str, payload: str):
    # ??? ????????? ?????? ??? ????? ????????? ??????????
    # ????????? ??? ???????
    event_data = {
        "topic": topic,
        "payload": json.loads(payload),
        "timestamp": datetime.now().isoformat()
    }
    
    for client_queue in sse_clients:
        try:
            client_queue.put_nowait(event_data)
        except:
            pass
```

### ????????? broadcast ? ?????? ??????:

```python
# ??? ????????? ??????
@app.get("/api/metrics")
async def metrics():
    m = calculate_metrics()
    await broadcast_to_sse_clients("home/system/metrics", json.dumps(m))
    return m

# ??? ????? ????????? ??????????
@app.post("/api/devices/{id}/toggle")
async def toggle(id: str):
    device = toggle_device(id)
    await broadcast_to_sse_clients(f"home/{id}/state", json.dumps(device))
    return device
```

---

## ?? ????????????

### ???????? 1: ? MQTT (?????????? ?????)

```bash
# ???????? 1: Mosquitto
mosquitto -c mosquitto.conf -v

# ???????? 2: FastAPI ??????
python main.py

# ???????? 3: MAUI ??????????
# ?????????: "Connection: Connected (MQTT)" ?
```

### ???????? 2: ??? MQTT (SSE fallback)

```bash
# ???????? 1: FastAPI ?????? (??? Mosquitto)
python main.py

# ???????? 2: MAUI ??????????
# ?????????: "Connection: Connected (SSE)" ?
# ? ???????????? ????? ??????? ? ??????????!
```

### ???????? 3: ???????????? SSE ????????

```bash
# ???????? 1: FastAPI ??????
python main.py

# ???????? 2: Python SSE ??????
python examples/sse_client_demo.py

# ?????????: ?????? ??? ??????? ? ???????? ???????
```

---

## ?? ????????????? ? ????

### ?? ??????? MAUI:

```csharp
public class DashboardVm : ObservableObject
{
    private readonly IRealtimeService _realtime;

    public DashboardVm(IRealtimeService realtime)
    {
        _realtime = realtime;
        _realtime.MetricsReceived += OnMetricsReceived;
    }

    public async Task InitializeAsync()
    {
        // ????????????? ???????? ?????? ????? ???????????!
        await _realtime.StartAsync();
    }

    private void OnMetricsReceived(object? sender, MetricsDto metrics)
    {
        // ???????? ????????? ??? MQTT ? SSE
        Temp = metrics.Temp;
        Humidity = metrics.Humidity;
        Power = metrics.Power;
    }

    // ???????? ???????? ??????
    public void CheckMode()
    {
        string mode = _realtime.CurrentMode; // "mqtt", "sse", ??? "disconnected"
        if (mode == "sse")
        {
            // ????????? ?????? ?????????? (read-only)
            CanToggleDevices = false;
        }
    }
}
```

---

## ?? ????? ??????? SSE

### Event Sequence ??? ???????????

```
1. Client connects to /api/events/stream
        ?
2. Server sends system/initial-state (?????? ?????????)
        ?
3. Client displays devices
        ?
4. Server sends home/*/metrics (?????? 5 ???)
        ?
5. Client updates UI with metrics
        ?
6. Server sends home/*/state (??? ?????????)
        ?
7. Client updates device status
        ?
8. Server sends system/keepalive (?????? 30 ???)
        ?
9. Client confirms connection is alive
```

---

## ?? ????????????

### SSE Mode (Guest Mode)

? **????????????:**
- ????? ???????????? ????? ????????????
- ??? ????????????? ??????? ??????
- ???????? ??? public dashboards

?? **???????????:**
- ?????? ?????? (no write access)
- ?????? ?????? ????????? ?????????
- HTTP only (??????????? HTTPS ? production)

### ???????????? ??? Production:

```python
# 1. ??????????? HTTPS
BASE_URL = "https://your-server.com"

# 2. ???????? rate limiting
from slowapi import Limiter
limiter = Limiter(key_func=get_remote_address)

@app.get("/api/events/stream")
@limiter.limit("1/second")  # 1 ??????????? ? ??? ? IP
async def event_stream(request: Request):
    pass

# 3. ???????? ???????????? ???????????
@app.get("/api/events/stream")
async def event_stream(request: Request, token: Optional[str] = Header(None)):
    if token:
        # Verify token
        pass
    # Rest of implementation
```

---

## ?? Checklist ??? Production

- [ ] ?????? ????? `/api/status` endpoint
- [ ] ?????? ????? `/api/events/stream` endpoint (SSE)
- [ ] MQTT ??????? broadcasting ? SSE ????????
- [ ] HTTPS ??????? ??? SSE endpoint
- [ ] Rate limiting ???????????
- [ ] ??????????? ?????????
- [ ] Test coverage ????????
- [ ] ???????????? ?????????

---

## ?? Troubleshooting

### SSE ?? ???????? ???????

1. ????????? ?????? ????
2. ????????? ??? `broadcast_to_sse_clients` ??????????
3. ????????? Event Source ? DevTools (F12)

```javascript
// ???????????? SSE ? ????????
const eventSource = new EventSource('http://localhost:8000/api/events/stream');
eventSource.onmessage = (event) => {
    console.log('Received:', JSON.parse(event.data));
};
eventSource.onerror = () => console.error('Connection failed');
```

### MQTT ?? ????????????? ?? SSE

1. ????????? `/api/status` endpoint
2. ????????? ??? `mqtt_available` ?????????? false
3. ????????? Debug ???? ? Visual Studio Output

---

## ?? ?????????????? ???????

- [`docs/FALLBACK.md`](../docs/FALLBACK.md) - ?????? ????????????
- [`docs/FALLBACK_QUICKSTART.md`](../docs/FALLBACK_QUICKSTART.md) - ??????? ?????
- [`examples/sse_client_demo.py`](examples/sse_client_demo.py) - Python ???????

---

## ? ?????

### ??? ?? ????????:

? ?????????????? ???????????? MQTT ? SSE  
? ?????? API ??? ????? ???????  
? Guest mode ?????? ??? ???????????  
? Production-ready implementation  
? ?????? ????????????  
? ??????? ?????????????  

### ?????? ???????????? ?????:

- ?? ????????????? graph??? ???? ??? Mosquitto
- ?? ???????? real-time ?????????? ????? SSE
- ?? ???????????? guest mode ??? ??????
- ?? ?????? ??????? ????? ??????????? ? UI

---

## ?? Next Steps

1. ?????????? `/api/status` ? `/api/events/stream` ?? ???????
2. ???????? `broadcast_to_sse_clients()` ??????
3. ????????????? ??? ???????? (?/??? MQTT)
4. Deploy ? production ? HTTPS

---

**???? ????????:** 2024-01-15  
**??????:** 1.0  
**??????:** ? Ready for Production
