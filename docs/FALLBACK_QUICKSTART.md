# ? Fallback Mode - Quick Start Guide

## ?? ??? ???? ???????????

???? ?????????? ?????? **????????????? ?????????????** ????? ????? ???????? ???????????:

```
???????????????????????????????????????
?   ?????????? ???????????            ?
???????????????????????????????????????
             ?
             ?
???????????????????????????????????????
? ????????? ?????? ???????            ?
? GET /api/status                     ?
???????????????????????????????????????
             ?
        ???????????
        ?         ?
   MQTT ?     MQTT ?
        ?         ?
        ?         ?
    MQTT Mode   SSE Mode
    (??????)    (Fallback)
```

---

## ?? ??? ??? ????????

### 1. **MQTT Mode** (Primary - ????? Mosquitto ????????)
- ? ?????? ??????????? ? Mosquitto (???? 8883)
- ? ??????? ???????? (~10ms latency)
- ? ??????? username/password
- ? ?????? ???????? (?????? + ??????)

### 2. **SSE Fallback Mode** (????? Mosquitto ??????????)
- ? Server-Sent Events ????? HTTP (?? FastAPI)
- ? ?????????????? ???????????? (?????????)
- ? **??? ???????????** (guest ?????!)
- ? ?????? ?????? (???????? ???????? + ?????????? UI)
- ?? ????????? (100-200ms latency)

---

## ?? ????????? ????????? ?? ???????

### FastAPI Server - ???????? SSE endpoint

```python
# main.py
from fastapi import FastAPI
from fastapi.responses import StreamingResponse
from typing import Set
import asyncio
import json

app = FastAPI()

# ????????? ???????????? SSE ????????
sse_clients: Set[asyncio.Queue] = set()

@app.get("/api/status")
async def get_status():
    """?????????? ?????? MQTT ???????????"""
    return {
        "mqtt_available": mqtt_connected,  # true if MQTT broker is accessible
        "mqtt_broker": MQTT_BROKER,
        "mqtt_port": MQTT_PORT,
        "recommended_mode": "mqtt" if mqtt_connected else "sse",
        "sse_clients_count": len(sse_clients),
        "timestamp": datetime.now().isoformat()
    }

@app.get("/api/events/stream")
async def event_stream(request: Request):
    """SSE endpoint ??? ????????? ?????????? ? ???????? ???????"""
    client_queue = asyncio.Queue(maxsize=100)
    sse_clients.add(client_queue)
    
    async def event_generator():
        try:
            # ?????????? ????????? ?????????
            yield f"data: {json.dumps({
                'topic': 'system/initial-state',
                'payload': {'devices': list(devices.values())}
            })}\n\n"
            
            # ??????? ?????????? ???????
            while True:
                if await request.is_disconnected():
                    break
                
                try:
                    event = await asyncio.wait_for(
                        client_queue.get(), 
                        timeout=30.0
                    )
                    yield f"data: {json.dumps(event)}\n\n"
                except asyncio.TimeoutError:
                    # Keepalive ?????? 30 ??????
                    yield f"data: {json.dumps({
                        'topic': 'system/keepalive',
                        'payload': {'mqtt_available': mqtt_connected}
                    })}\n\n"
        finally:
            sse_clients.discard(client_queue)
    
    return StreamingResponse(
        event_generator(),
        media_type="text/event-stream",
        headers={"Cache-Control": "no-cache"}
    )

async def broadcast_to_sse_clients(topic: str, payload: str):
    """?????????? ??????? ???? ???????????? SSE ????????"""
    event_data = {
        "topic": topic,
        "payload": json.loads(payload),
        "timestamp": datetime.now().isoformat()
    }
    
    for client_queue in list(sse_clients):
        try:
            client_queue.put_nowait(event_data)
        except:
            sse_clients.discard(client_queue)

# ??? ?????????? ??????:
async def on_metrics_received(metrics):
    # ?????????? ? SSE ????????
    await broadcast_to_sse_clients(
        "home/system/metrics",
        json.dumps(metrics)
    )

# ??? ????????? ????????? ??????????:
async def on_device_state_changed(device_id, state):
    device = devices.get(device_id)
    if device:
        # ?????????? ? SSE ????????
        await broadcast_to_sse_clients(
            f"home/{device_id}/state",
            json.dumps(device)
        )
```

---

## ?? ????????????? ?? ??????? MAUI

### ?????????????? ????? (?????????????)

```csharp
// DashboardVm.cs
public partial class DashboardVm : ObservableObject
{
    private readonly IRealtimeService _realtime;

    public DashboardVm(IRealtimeService realtime)
    {
        _realtime = realtime;
        
        // ????????????? ?? ??????? (???????? ?????????????)
        _realtime.MetricsReceived += OnMetricsReceived;
        _realtime.ConnectionStatusChanged += OnStatusChanged;
    }

    public async Task InitializeAsync()
    {
        // ????????????? ???????? MQTT ??? SSE
        await _realtime.StartAsync();
    }

    private void OnMetricsReceived(object? sender, MetricsDto metrics)
    {
        MainThread.BeginInvokeOnMainThread(() =>
        {
            Temp = metrics.Temp;
            Humidity = metrics.Humidity;
            Power = metrics.Power;
            Status = $"Online ({_realtime.CurrentMode.ToUpper()})";
        });
    }

    private void OnStatusChanged(object? sender, string status)
    {
        MainThread.BeginInvokeOnMainThread(() =>
        {
            ConnectionStatus = $"{status} ({_realtime.CurrentMode})";
        });
    }
}
```

### ???????? ???????? ??????

```csharp
// ????????? ????? ???????????
if (_realtime.CurrentMode == "mqtt")
{
    // MQTT ??????? - ?????? ??????????
}
else if (_realtime.CurrentMode == "sse")
{
    // SSE fallback - ?????? ??????
    DisableDeviceToggle();
}
else
{
    // ?????????
    ShowOfflineMessage();
}
```

---

## ?? UI Indications

???????? `DashboardPage.xaml` ????? ?????????? ??????? ?????:

```xaml
<Label FontSize="12" TextColor="Gray">
    <Label.FormattedText>
        <FormattedString>
            <Span Text="Connection: "/>
            <Span Text="{Binding RealtimeStatus}"/>
            <Span Text=" ("/>
            <Span Text="{Binding RealtimeMode}"/>
            <Span Text=")"/>
        </FormattedString>
    </Label.FormattedText>
</Label>
```

?????????:
- ? "Connection: Connected (MQTT)"
- ? "Connection: Connected (SSE)"
- ? "Connection: Disconnected (—)"

---

## ?? ????????????

### ???????? 1: MQTT ????????

```bash
# ????????? Mosquitto
mosquitto -c mosquitto.conf -v

# ????????? FastAPI ??????
python main.py

# ????????? MAUI ??????????
# ? ?????????? ??????????? ????? MQTT
# ? UI ??????? "Connection: Connected (MQTT)"
```

### ???????? 2: ?????? SSE (??? MQTT)

```bash
# ?? ?????????? Mosquitto

# ????????? FastAPI ??????
python main.py

# ????????? MAUI ??????????
# ? ?????????? ?? ?????? ???????????? ? MQTT
# ? ????????????? ???????????? ?? SSE
# ? UI ??????? "Connection: Connected (SSE)"
# ? ???????????? ????? ??????? ? ??????????
```

### ???????? 3: ??? ??????? ??????????

```bash
# ?? ?????????? Mosquitto
# ?? ?????????? FastAPI

# ????????? MAUI ??????????
# ? ??? ??????? ??????????? ?? ?????????
# ? UI ??????? "Connection: Disconnected (—)"
# ? ?????????? ??????? ???????????? ??????
```

---

## ?? ??? ???? ???????

### ????? ?????:

1. **`Services/SseService.cs`** - SSE ??????
2. **`Services/RealtimeService.cs`** - Unified ?????? ? ?????????????? fallback
3. **`docs/FALLBACK.md`** - ?????? ????????????

### ?????????? ?????:

1. **`MauiProgram.cs`** - ??????????? ????? ????????
2. **`ViewModels/DashboardVm.cs`** - ????????????? `IRealtimeService`
3. **`Views/DashboardPage.xaml`** - ??????????? ?????? ???????????
4. **`Services/IApiClient.cs`** - ???????? `GetAsync<T>` ?????
5. **`Services/ApiClient.cs`** - ?????????? `GetAsync<T>`

---

## ? ???????? ???????????

### ? ?????????????? ????????????
- ?????????? ????????????? ???????? ?????? ????????? ?????? ???????????
- ??? ????????????? ?????? ??? ??? ????????????

### ? ?????????? API
- ???? ????????? `IRealtimeService` ??? ????? ???????
- ViewModels ?? ????? ????? ? MQTT vs SSE

### ? Graceful degradation
- ? MQTT: ?????? ?????????? (?????? + ??????)
- ? SSE: ?????? ?????? (guest mode)
- ??? ???????: ???????????? ??????

### ? Production-ready
- Automatic reconnection
- Error handling
- Debug logging
- Keepalive signals

---

## ?? ????????????

### SSE Mode (Guest Mode)

- ?? **??? ???????????** - ????? ????? ????????????
- ? ?????? ?????? - ?????? ?????? ?????????
- ?? HTTP ?????? (??????????? HTTPS ? production)

### ????????????:

```csharp
// production/appsettings.json
{
  "BaseUrl": "https://your-server.com/",  // HTTPS!
  "SseReadOnly": true                      // Guest mode
}
```

---

## ?? Summary

| ?????? | MQTT | SSE |
|--------|------|-----|
| ??????? | ????????? Mosquitto | ???????? ? FastAPI |
| ???????? | ?????? (~10ms) | ????????? (~100ms) |
| ??????? | R/W | R (?????? ??????) |
| ????????? | ???? | ???? |
| Fallback | N/A | ? Yes |
| Guest Mode | ? ??? | ? ?? |

**????:** ?????? ???????????? ????? ????????????? ??????? ? ???????? ?????????? **???? ??? Mosquitto**, ????????? SSE fallback ?????! ??

---

??? ?????? ?????????? ??. [`docs/FALLBACK.md`](../FALLBACK.md)
