# SmartHome2 Architecture

## System Overview

```
???????????????????????????????????????????????????????????????????????????
?                          End User Devices                                ?
?  ????????????????  ????????????????  ????????????????  ??????????????? ?
?  ?   Windows    ?  ?   Android    ?  ?     iOS      ?  ?    macOS    ? ?
?  ?   Desktop    ?  ?    Phone     ?  ?    Phone     ?  ?   Desktop   ? ?
?  ????????????????  ????????????????  ????????????????  ??????????????? ?
?         ?                  ?                  ?                  ?        ?
?         ??????????????????????????????????????????????????????????        ?
?                                     ?                                     ?
?????????????????????????????????????????????????????????????????????????????
                                      ?
???????????????????????????????????????????????????????????????????????????
?                        SmartHome2 MAUI App                               ?
???????????????????????????????????????????????????????????????????????????
?                                                                          ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?                    Presentation Layer (Views)                   ?    ?
?  ?  ???????????? ???????????? ???????????? ????????????????????  ?    ?
?  ?  ?  Login   ? ?Dashboard ? ? Devices  ? ?  Charts/Settings ?  ?    ?
?  ?  ?  (XAML)  ? ?  (XAML)  ? ?  (XAML)  ? ?      (XAML)      ?  ?    ?
?  ?  ???????????? ???????????? ???????????? ????????????????????  ?    ?
?  ??????????????????????????????????????????????????????????????????    ?
?          ?            ?            ?                  ?                 ?
?          ?            ?            ?                  ?                 ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?              Business Logic Layer (ViewModels)                  ?    ?
?  ?  ???????????? ???????????? ???????????? ????????????????????  ?    ?
?  ?  ? LoginVm  ? ?Dashboard ? ?DevicesVm ? ?  ChartsVm/       ?  ?    ?
?  ?  ?          ? ?   Vm     ? ?          ? ?  SettingsVm      ?  ?    ?
?  ?  ???????????? ???????????? ???????????? ????????????????????  ?    ?
?  ??????????????????????????????????????????????????????????????????    ?
?          ?            ?            ?                  ?                 ?
?          ??????????????????????????????????????????????                 ?
?                                   ?                                     ?
?                                   ?                                     ?
?  ??????????????????????????????????????????????????????????????????    ?
?  ?                    Service Layer                                ?    ?
?  ?  ??????????????  ??????????????  ???????????????????????????? ?    ?
?  ?  ? ApiClient  ?  ?MqttService ?  ?   SqliteDataStore        ? ?    ?
?  ?  ?  (HTTP)    ?  ?  (MQTT)    ?  ?     (SQLite)             ? ?    ?
?  ?  ?            ?  ?            ?  ?                          ? ?    ?
?  ?  ?  - Polly   ?  ? - MQTTnet  ?  ?  - sqlite-net-pcl       ? ?    ?
?  ?  ?  - Retry   ?  ? - TLS/SSL  ?  ?  - Async operations     ? ?    ?
?  ?  ?  - Timeout ?  ? - Reconnect?  ?  - Lazy init            ? ?    ?
?  ?  ??????????????  ??????????????  ???????????????????????????? ?    ?
?  ???????????????????????????????????????????????????????????????????    ?
?           ?                 ?                  ?                        ?
???????????????????????????????????????????????????????????????????????????
            ?                 ?                  ?
            ?                 ?                  ?
????????????????????????????????????????????????????????????????????????????
?                        Backend Services                                   ?
????????????????????????????????????????????????????????????????????????????
?                                                                           ?
?  ???????????????????????????        ?????????????????????????????????   ?
?  ?     FastAPI Server      ??????????    Mosquitto MQTT Broker      ?   ?
?  ?                         ?        ?                               ?   ?
?  ?  Endpoints:             ?        ?  Topics:                      ?   ?
?  ?  - GET /api/metrics     ?        ?  - home/+/metrics             ?   ?
?  ?  - GET /api/devices     ?        ?  - home/+/state               ?   ?
?  ?  - POST /api/devices/   ?        ?                               ?   ?
?  ?         {id}/toggle     ?        ?  Features:                    ?   ?
?  ?                         ?        ?  - TLS/SSL encryption         ?   ?
?  ?  Features:              ?        ?  - Client certificates (mTLS) ?   ?
?  ?  - ACL authorization    ?        ?  - ACL access control         ?   ?
?  ?  - Rate limiting        ?        ?  - Persistent sessions        ?   ?
?  ?  - Request validation   ?        ?  - QoS 0/1/2 support          ?   ?
?  ???????????????????????????        ?????????????????????????????????   ?
?            ?                                                              ?
?            ?                                                              ?
?  ???????????????????????????                                             ?
?  ?   Database (SQLite)     ?                                             ?
?  ?  - Device states        ?                                             ?
?  ?  - Metrics history      ?                                             ?
?  ?  - User credentials     ?                                             ?
?  ???????????????????????????                                             ?
?                                                                           ?
?????????????????????????????????????????????????????????????????????????????
```

---

## Data Flow

### 1. Real-time Metrics Update (MQTT Push)

```
Sensor Device
    ?
    ?
FastAPI Server (receives sensor data)
    ?
    ???? Database (stores metrics)
    ?
    ???? Mosquitto Broker (publishes to home/sensor/metrics)
            ?
            ?
        MqttService (MAUI app subscribes)
            ?
            ?
        DashboardVm (updates properties)
            ?
            ?
        DashboardPage (UI updates automatically via binding)
```

### 2. Device Toggle (HTTP Command)

```
User taps Toggle button
    ?
    ?
DevicesVm.ToggleDeviceCommand
    ?
    ?
ApiClient.ToggleDeviceAsync() ? POST /api/devices/lamp/toggle
    ?
    ?
FastAPI Server
    ?
    ???? Checks ACL (Admin only)
    ???? Updates device state
    ???? Publishes to MQTT: home/lamp/state
    ???? Returns new state via HTTP
            ?
            ?
        DevicesVm (updates UI)
            ?
            ???? Updates Devices collection
            ???? Saves to SQLite cache
                    ?
                    ?
                DevicesPage (UI reflects change)
```

### 3. Offline Caching

```
HTTP Request fails (no network)
    ?
    ?
ApiClient throws exception
    ?
    ?
ViewModel catches exception
    ?
    ???? SqliteDataStore.LoadMetricsAsync()
            ?
            ?
        Returns cached data
            ?
            ?
        UI displays "Offline (cached)" status
```

---

## Component Diagram

```
???????????????????????????????????????????????????????????????
?                      MAUI Application                        ?
???????????????????????????????????????????????????????????????
?                                                              ?
?  [Views] ????????? [ViewModels] ????????? [Services]       ?
?     ?                   ?                      ?             ?
?     ?                   ?                      ??? ApiClient ?
?     ?                   ?                      ??? MqttSvc   ?
?     ?                   ?                      ??? DataStore ?
?     ?                   ?                                    ?
?     ?                   ????????? [Models]                   ?
?     ?                               ?                        ?
?     ?                               ??? MetricsDto           ?
?     ?                               ??? DeviceDto            ?
?     ?                                                        ?
?     ????????????????????? [Resources]                        ?
?                             ?                                ?
?                             ??? AppResources (i18n)          ?
?                             ??? Styles (XAML)                ?
?                             ??? Images                       ?
?                                                              ?
????????????????????????????????????????????????????????????????
```

---

## Technology Stack Layers

```
???????????????????????????????????????????????????????????
?  Presentation: .NET MAUI 8.0 + XAML                     ?
???????????????????????????????????????????????????????????
?  MVVM: CommunityToolkit.Mvvm 8.2.2                      ?
???????????????????????????????????????????????????????????
?  Business Logic: C# 12.0 ViewModels                     ?
???????????????????????????????????????????????????????????
?  Services:                                              ?
?    - HTTP: HttpClient + Polly 8.0                       ?
?    - MQTT: MQTTnet 4.3.7                                ?
?    - DB: sqlite-net-pcl 1.9.172                         ?
???????????????????????????????????????????????????????????
?  UI Components: LiveChartsCore + SkiaSharp              ?
???????????????????????????????????????????????????????????
?  Platform: Windows / Android / iOS / macOS              ?
???????????????????????????????????????????????????????????
```

---

## Deployment Architecture

```
????????????????????????????????????????????????????????????????
?                    Production Environment                     ?
????????????????????????????????????????????????????????????????
?                                                               ?
?  ???????????????????      ????????????????????????????????  ?
?  ?  Mobile Devices ?      ?   Desktop Devices            ?  ?
?  ?  (Android/iOS)  ?      ?   (Windows/macOS)            ?  ?
?  ???????????????????      ????????????????????????????????  ?
?           ?                          ?                        ?
?           ????????????????????????????                        ?
?                          ?                                    ?
?                          ?                                    ?
?           ????????????????????????????????                   ?
?           ?   Internet / Local Network   ?                   ?
?           ????????????????????????????????                   ?
?                          ?                                    ?
?           ????????????????????????????????                   ?
?           ?                               ?                   ?
?           ?                               ?                   ?
?  ??????????????????            ????????????????????          ?
?  ?  FastAPI       ??????????????  Mosquitto       ?          ?
?  ?  (Port 8000)   ?            ?  (Port 8883)     ?          ?
?  ??????????????????            ????????????????????          ?
?           ?                                                   ?
?           ?                                                   ?
?  ??????????????????                                          ?
?  ?  PostgreSQL    ?                                          ?
?  ?  (or SQLite)   ?                                          ?
?  ??????????????????                                          ?
?                                                               ?
?????????????????????????????????????????????????????????????????
```

---

## Security Architecture

```
??????????????????????????????????????????????????????????????
?                     Security Layers                         ?
??????????????????????????????????????????????????????????????
?                                                             ?
?  1. Transport Layer                                         ?
?     ?? HTTPS (TLS 1.2/1.3) for HTTP API                   ?
?     ?? MQTTS (TLS 1.2/1.3) for MQTT                       ?
?                                                             ?
?  2. Authentication                                          ?
?     ?? Basic Auth / JWT for HTTP                          ?
?     ?? Username/Password for MQTT                         ?
?     ?? Client Certificates (mTLS) for MQTT                ?
?                                                             ?
?  3. Authorization                                           ?
?     ?? Role-Based Access Control (RBAC)                   ?
?     ?  ?? Admin: Full control                             ?
?     ?  ?? Guest: Read-only                                ?
?     ?? Mosquitto ACL for topic-level permissions          ?
?                                                             ?
?  4. Data Protection                                         ?
?     ?? Encrypted MQTT payloads (optional)                 ?
?     ?? Secure credential storage (Preferences)            ?
?     ?? Certificate validation                             ?
?                                                             ?
???????????????????????????????????????????????????????????????
```

---

**Architecture Version:** 1.0  
**Last Updated:** 2024-01-15
