# ? ??????????: Fallback ?????? ??? ???????? ????

## ?? ??? ???? ??????????

### ????????:
> "fallback ??????????? ?????? ???? ???? mosquitto ??????? ??? ????? ??????? ?????? ? ?????? ????? connect ?? ?????? ? ?????? ????? guest ???"

### ???????:
- `RealtimeService` ???????? `/api/status` **??** ??????? ???????????
- ???? `mqtt_available=false`, ????? ???????????? ?? SSE
- ?? ????? MQTT ???? ?????????? ????????????

### ???????:
? **RealtimeService ????????:**
- **??????? ?????? ???????? MQTT** (???? credentials ???????)
- ???? 2 ??????? ??? ????????? ??????????
- **?????? ???? MQTT failed** ? ????????? SSE fallback
- SSE ???????????? ?????? ??? **????????? ?????**

? **LoginVm ????????:**
- ????? ?????????????? guest login ??? ????????
- Guest mode ???????????? **?????? ??? ????** ???????? login
- ?????????? banner ?????? ????? ????????????? ????? fallback

---

## ?? ??? ???????? ??????

### ???????? 1: MQTT ???????? (?????)

```
1. ???????????? ?????? credentials (admin:admin ??? guest:123)
        ?
2. ???????? Login
        ?
3. RealtimeService.StartAsync()
        ?
4. ???????? MQTT ???????????
        ?
5. MQTT ??????? ??????????? ?
        ?
6. CurrentMode = "mqtt"
        ?
7. ??????? ?? Dashboard
        ?
8. Dashboard ??????????:
   "Connection: Connected (MQTT) ?"
```

### ???????? 2: MQTT ?? ???????? (fallback)

```
1. ???????????? ?????? credentials (guest:123)
        ?
2. ???????? Login
        ?
3. RealtimeService.StartAsync()
        ?
4. ???????? MQTT ???????????
        ?
5. ???? 2 ???????...
        ?
6. MQTT ?? ??????????? ?
        ?
7. ????????? /api/status
        ?
8. ????? SSE ????????
        ?
9. ????????????? ?? SSE
        ?
10. CurrentMode = "sse"
        ?
11. ??????? ?? Dashboard
        ?
12. Dashboard ??????????:
    "Connection: Connected (SSE) ?"
```

### ???????? 3: Admin ? MQTT ???????????

```
1. ???????????? ?????? credentials (admin:admin)
        ?
2. ???????? Login
        ?
3. ???????? MQTT
        ?
4. MQTT failed ?
        ?
5. ????????? SSE
        ?
6. SSE fallback ???????? ?
        ?
7. ??????? ?? Dashboard
        ?
8. ?? ?????? ? "guest ??????" (read-only)
   ?????? ??? SSE = guest mode
```

---

## ?? ?????? ???????? ???????

```csharp
// RealtimeService.StartAsync()

// ??? 1: ?????? ??????? MQTT ???? ???? credentials
if (AppSettings.MqttUseTls && !string.IsNullOrEmpty(AppSettings.MqttUsername))
{
    await StartMqttAsync();
    await Task.Delay(2000); // ???? ???????????
    
    if (_mqttService.IsConnected)
    {
        _currentMode = "mqtt";
        return; // ? ????? - ???????
    }
}

// ??? 2: MQTT failed - ??????? SSE fallback
var serverStatus = await CheckServerStatusAsync();
if (serverStatus != null)
{
    await StartSseAsync();
    _currentMode = "sse";
}
else
{
    _currentMode = "disconnected"; // ? ?????? ?? ????????
}
```

---

## ?? ????????????

### ???? 1: ? Mosquitto (?????? ???????????? MQTT)

```bash
# 1. ????????? Mosquitto
mosquitto -c mosquitto.conf -v

# 2. ????????? FastAPI ??????
python main.py

# 3. ????????? MAUI ??????????
# 4. ??????? ??? guest:123
# 5. ????????? Dashboard:
#    ? "Connection: Connected (MQTT)" ?
#    ? ?? "SSE"!
```

### ???? 2: ??? Mosquitto (?????? ???????????? SSE)

```bash
# 1. ?? ?????????? Mosquitto
# 2. ????????? FastAPI ??????
python main.py

# 3. ????????? MAUI ??????????
# 4. ??????? ??? guest:123
# 5. ????? ~2-3 ??????? (MQTT timeout)
# 6. ????????? Dashboard:
#    ? "Connection: Connected (SSE)" ?
#    ? Guest mode fallback ????????
```

### ???? 3: Admin ? ?????? SSE

```bash
# 1. ?? ?????????? Mosquitto
# 2. ????????? FastAPI ??????

# 3. ??????? ??? admin:admin
# 4. MQTT ?????????? ???????????? ? ??????????
# 5. Fallback ?? SSE ?
# 6. Dashboard ??????????:
#    ? "Connection: Connected (SSE)"
#    ? ?? ?????? ?????????? ????? ???? disabled (read-only)
```

---

## ?? Debug Output

### ??? MQTT success:

```
RealtimeService: Starting...
RealtimeService: Attempting MQTT connection...
MqttService: Starting...
MqttService: Broker=127.0.0.1:8883
MqttService: Attempting connection...
MqttService: Connection successful!
RealtimeService: MQTT connected successfully
RealtimeService: Current mode = mqtt
```

### ??? MQTT fail ? SSE fallback:

```
RealtimeService: Starting...
RealtimeService: Attempting MQTT connection...
MqttService: Starting...
MqttService: Broker=127.0.0.1:8883
MqttService: Attempting connection...
MqttService: Connection failed - Connection refused
RealtimeService: MQTT connection failed
RealtimeService: Checking SSE fallback availability...
RealtimeService: Server status - MQTT: False, Recommended: sse
RealtimeService: Attempting SSE fallback...
SseService: Starting SSE connection...
SseService: Connecting to http://127.0.0.1:8000/api/events/stream
SseService: Connected ?
RealtimeService: Current mode = sse
```

---

## ?? ?????????

### ???????? MQTT timeout (??????? fallback):

```csharp
// Services/RealtimeService.cs - line ~60

await Task.Delay(2000).ConfigureAwait(false); // 2 ???????

// ????? ????????? ?? 1 ??????? ??? ???????? ?????:
await Task.Delay(1000).ConfigureAwait(false);
```

### ????????????? ????????? MQTT (???????????? SSE):

```csharp
// Services/AppSettings.cs

public static bool MqttUseTls
{
    get => false; // ? ????????????? false
    set => Preferences.Set(MqttUseTlsKey, value);
}

// ?????? ?????? ????? SSE mode
```

---

## ?? ????????? ?? ?????????

| ???????? | MQTT Broker | ????????? | Mode |
|----------|-------------|-----------|------|
| Normal login | ? Running | MQTT connection | `mqtt` |
| Guest with MQTT down | ? Stopped | SSE fallback | `sse` |
| Admin with MQTT down | ? Stopped | SSE fallback | `sse` |
| No server at all | ? Stopped | Error message | `disconnected` |
| Quick Login Guest | ? Running | MQTT connection | `mqtt` |
| Quick Login Admin | ? Running | MQTT connection | `mqtt` |

---

## ? ???????? ???????

### ?? (????????):

```
RealtimeService.StartAsync()
    ?
????????? /api/status
    ?
mqtt_available = false?
    ? ??
????? SSE, ?? ???????? MQTT ?
```

### ????? (??????????):

```
RealtimeService.StartAsync()
    ?
???????? MQTT
    ?
???? 2 ???
    ?
MQTT connected?
    ? ???
????????? /api/status
    ?
??????? SSE fallback ?
```

---

## ?? Checklist ????????????

- [ ] ? Mosquitto: ???? ??? guest ? ?????????? MQTT
- [ ] ? Mosquitto: ???? ??? admin ? ?????????? MQTT
- [ ] ??? Mosquitto: ???? ??? guest ? ?????????? SSE (????? 2-3 ???)
- [ ] ??? Mosquitto: ???? ??? admin ? ?????????? SSE (????? 2-3 ???)
- [ ] Quick Login Guest (? MQTT) ? MQTT mode
- [ ] Quick Login Guest (??? MQTT) ? SSE mode
- [ ] Debug Output ?????????? ?????????? ??????????????????

---

## ?? Troubleshooting

### ????????: ??? ??? ?????????? SSE ???? ? MQTT

**?????????:**
1. Mosquitto ????????????? ????????
```bash
ps aux | grep mosquitto
# ??? Windows:
tasklist | findstr mosquitto
```

2. MQTT credentials ???????????
```csharp
// Debug Output ?????? ??????????:
MqttService: Username=guest (??? admin)
MqttService: Attempting connection...
```

3. ???? ???????????
```csharp
// AppSettings.MqttPort ?????? ???? 8883 ??? 1883
System.Diagnostics.Debug.WriteLine($"Port: {AppSettings.MqttPort}");
```

### ????????: MQTT timeout ??????? ??????

**???????:**
```csharp
// Services/RealtimeService.cs
await Task.Delay(1000).ConfigureAwait(false); // ????????? ?? 1 ???
```

### ????????: SSE ?? ???????? ????? MQTT fail

**?????????:**
```bash
# ?????? ????? /api/events/stream?
curl -N http://127.0.0.1:8000/api/events/stream
```

---

## ?? ?????

### ??? ??????????:

? MQTT **?????? ???????? ???????????? ??????**  
? SSE fallback **?????? ??? ???????? ????**  
? ??? ???????????????? ???????????? ?? SSE  
? ?????????? ??????????????????: MQTT ? (fail) ? SSE  

### ??????:

- ? Mosquitto ? **?????? MQTT** ?
- ??? Mosquitto ? **SSE fallback** ?
- ??? ?????? ???????????? fallback ?

---

**????:** 2024-01-15  
**??????:** 1.2  
**??????:** ? **??????????!**
