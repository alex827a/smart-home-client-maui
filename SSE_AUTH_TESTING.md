# ?? Testing SSE Authentication - Quick Guide

## ??????? ?????

### 1. ?????? ??????? ? ???????????????

```bash
cd /path/to/smart-home-backend

# ?????????? ?????????? ????????? (???????????)
export GUEST_PASSWORD="123"
export ADMIN_PASSWORD="admin123"

# ????????? ??????
python main.py
# ???
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

**????????? ?????:**
```
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

### 2. ???? ????? Curl (???????? ???????)

#### ???? 1: ??????? (Guest)
```bash
curl -u guest:123 http://127.0.0.1:8000/api/metrics
```

**????????? ?????????:**
```json
{
  "temp": 23.4,
  "humidity": 45,
  "power": 320,
  "ts": "2025-01-15T14:30:00"
}
```

#### ???? 2: ?????????? (Guest)
```bash
curl -u guest:123 http://127.0.0.1:8000/api/devices
```

**????????? ?????????:**
```json
[
  {"id": "lamp", "name": "Lamp", "isOn": false, "lastSeen": "..."},
  {"id": "hvac", "name": "HVAC", "isOn": true, "lastSeen": "..."}
]
```

#### ???? 3: Toggle ?????????? (Guest - should fail)
```bash
curl -u guest:123 -X POST http://127.0.0.1:8000/api/devices/lamp/toggle
```

**????????? ?????????:**
```json
{
  "detail": "User 'guest' with role 'guest' cannot control devices. Admin role required."
}
```
**Status:** 403 Forbidden ?

#### ???? 4: Toggle ?????????? (Admin - success)
```bash
curl -u admin:admin123 -X POST http://127.0.0.1:8000/api/devices/lamp/toggle
```

**????????? ?????????:**
```json
{
  "id": "lamp",
  "name": "Lamp",
  "isOn": true,
  "lastSeen": "2025-01-15T14:30:05"
}
```
**Status:** 200 OK ?

#### ???? 5: SSE Stream (Guest)
```bash
curl -u guest:123 -N http://127.0.0.1:8000/api/events/stream
```

**????????? ?????????:**
```
data: {"topic":"system/connection","payload":{...},"timestamp":"..."}

data: {"topic":"system/initial-state","payload":{...},"timestamp":"..."}

data: {"topic":"home/system/metrics","payload":{...},"timestamp":"..."}
```

### 3. ???? ????? MAUI ??????

#### ???????? 1: Guest Login (Read-only)

1. ????????? MAUI ??????????
2. ?? ?????? Login ???????:
   - Username: `guest`
   - Password: `123`
3. ??????? **Login** ??? **Guest** ??????

**????????? ?????????:**
- ? ???????? ???????????: `Connection: Connected (SSE)`
- ? ??????? ??????????? ? ???????? ???????
- ? ?????? ????????? ????????????
- ? ????? ??????? ???????? Devices
- ? ??? ??????? Toggle: "User 'guest' with role 'guest' cannot control devices"

#### ???????? 2: Admin Login (Full access)

1. Logout (Settings ? Logout)
2. ?? ?????? Login ???????:
   - Username: `admin`
   - Password: `admin123`
3. ??????? **Login** ??? **Admin** ??????

**????????? ?????????:**
- ? ???????? ???????????: `Connection: Connected (SSE)`
- ? ??????? ??????????? ? ???????? ???????
- ? ?????? ????????? ????????????
- ? Toggle ????????? ????????
- ? ?????? ?????????? ??????????? ?????????

#### ???????? 3: Invalid Credentials

1. ?? ?????? Login ???????:
   - Username: `invalid`
   - Password: `wrong`
2. ??????? **Login**

**????????? ?????????:**
- ? ??????: "Failed to connect"
- ? ??? ? Output: "ApiClient: Unauthorized (401)"
- ? ???????? ?? ?????? Login

### 4. ???????? ?????

#### Visual Studio Output Window

**Debug ? Windows ? Output** (select "Debug")

**Guest ???????? ?????:**
```
LoginVm: Attempting login as guest...
ApiClient: Basic Auth configured for user 'guest'
SseService: Using Basic Auth for user 'guest'
SseService: Connected
RealtimeService: SSE mode active
LoginVm: Connected successfully via SSE
```

**Admin ???????? ?????:**
```
LoginVm: Attempting login as admin...
ApiClient: Basic Auth configured for user 'admin'
SseService: Using Basic Auth for user 'admin'
SseService: Connected
RealtimeService: SSE mode active
LoginVm: Connected successfully via SSE
```

**???????? credentials:**
```
LoginVm: Attempting login as invalid...
ApiClient: Unauthorized (401) - check credentials
SseService: Unauthorized (401) - Invalid credentials
LoginVm: Login exception - Invalid credentials
```

**Guest ???????? Toggle:**
```
DevicesVm: Toggling device 'lamp'...
ApiClient: ToggleDeviceAsync failed - User does not have permission to control devices
DevicesVm: Toggle failed for 'lamp' - Access denied
```

#### ????????? ???? (FastAPI)

```bash
# Terminal ? uvicorn
INFO:     127.0.0.1:64834 - "GET /api/metrics HTTP/1.1" 200 OK
INFO:     127.0.0.1:64834 - "GET /api/events/stream HTTP/1.1" 200 OK
INFO:     SSE client connected (user: guest, role: guest). Active clients: 1
INFO:     127.0.0.1:64835 - "POST /api/devices/lamp/toggle HTTP/1.1" 403 Forbidden
```

## ???-???? ????????????

### ? ???????? ???????

- [ ] Guest ????? ??????????
- [ ] Admin ????? ??????????
- [ ] ???????? credentials ???????????
- [ ] SSE ????? ???????? ??? guest
- [ ] SSE ????? ???????? ??? admin
- [ ] ??????? ??????????? ? ???????? ???????
- [ ] ?????? ????????? ???????????
- [ ] Guest ?? ????? ??????????? ?????????? (403)
- [ ] Admin ????? ??????????? ?????????? (200)
- [ ] ????????? ?????????? ??????????? ????? toggle

### ? Edge Cases

- [ ] ??????????????? ????? ?????? ?????
- [ ] ????? ???????????? (logout ? login)
- [ ] ?????? username/password
- [ ] ??????? ?????? (>100 ????????)
- [ ] ??????????? ??????? ? ??????
- [ ] Concurrent ??????? ?? ?????? ????????????
- [ ] Multiple SSE connections ?? ?????? ????????

### ? ????????????

- [ ] Basic Auth ????????? ???????????? ?? ???? ????????
- [ ] 401 ??? ?????????? credentials
- [ ] 401 ??? ???????? credentials
- [ ] 403 ??? ????????????? ?????? (guest toggle)
- [ ] Credentials ?? ?????????? ? plaintext
- [ ] Password ?? ???????????? ? UI

## Troubleshooting

### ????????: "401 Unauthorized" ?? ???? ????????

**??????? 1:** ?????????, ??? credentials ???????????
```csharp
// ???????? Debug.WriteLine ? LoginVm.cs
System.Diagnostics.Debug.WriteLine($"Username: '{AppSettings.MqttUsername}'");
System.Diagnostics.Debug.WriteLine($"Password length: {AppSettings.MqttPassword?.Length ?? 0}");
```

**??????? 2:** ????????? ????????? credentials
```bash
# ? ????????? ???????
python -c "import os; print('GUEST_PASSWORD:', os.getenv('GUEST_PASSWORD', '123'))"
python -c "import os; print('ADMIN_PASSWORD:', os.getenv('ADMIN_PASSWORD', 'admin123'))"
```

### ????????: SSE ????????????, ?? ?? ???????? ???????

**???????:** ?????????, ??? ?????? ????????? ???????
```bash
# ? ????? ??????? ?????? ????:
MQTT (fallback): home/system/metrics -> {"temp":23.4,...}
```

### ????????: Toggle ???????? ??? guest (?? ??????)

**???????:** ????????? ????????? ???
```python
# ? toggle endpoint ?????? ???? ????????:
if not user["can_control"]:
    raise HTTPException(status_code=403, ...)
```

## ?????????????? ???????????

### Python SSE Client ??? ????????????

```python
import requests
from requests.auth import HTTPBasicAuth

# SSE ???????????
response = requests.get(
    'http://127.0.0.1:8000/api/events/stream',
    auth=HTTPBasicAuth('guest', '123'),
    stream=True
)

for line in response.iter_lines():
    if line:
        print(line.decode('utf-8'))
```

### Postman Collection

???????????? ??? ????????? ? Postman:

```json
{
  "info": {"name": "SmartHome SSE Auth Tests"},
  "item": [
    {
      "name": "Get Metrics (Guest)",
      "request": {
        "method": "GET",
        "url": "http://127.0.0.1:8000/api/metrics",
        "auth": {
          "type": "basic",
          "basic": [
            {"key": "username", "value": "guest"},
            {"key": "password", "value": "123"}
          ]
        }
      }
    }
  ]
}
```

---

**????????? ????????????! ??**
