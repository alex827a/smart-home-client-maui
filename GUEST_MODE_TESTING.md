# ?? ???????????? Guest Mode Auto-Login

## ? ??? ???? ??????????

### ????????:
- ?????????? ?????????? ????? ?????? ???? ????? MQTT ??????????
- ???????????? ?? ??? ??????? ?????? ? SSE fallback ??????
- ?????????? ???? credentials ???? ??? guest mode

### ???????:
- ? `LoginVm` ?????? ?????????? `IRealtimeService` ?????? `IMqttService`
- ? ?????????????? ???????? ??????????? ??????? ??? ???????? LoginPage
- ? **Auto-login ??? guest** ???? ???????? ?????? SSE ?????
- ? ?????????? ????????? "Guest Mode Available"
- ? ?????????????? ??????? ?? Dashboard ????? 2 ???????

---

## ?? ??? ??????????????

### ???????? 1: SSE Guest Mode (??? MQTT)

```bash
# 1. ????????? ??? Mosquitto ?? ???????
# (?????????? ??? ??? ?? ?????????? ??????)

# 2. ????????? FastAPI ?????? ? SSE endpoints
cd path/to/backend
python main.py

# ?????? ?????? ?????:
# - GET /api/status ? {"mqtt_available": false, ...}
# - GET /api/events/stream ? SSE stream

# 3. ????????? MAUI ??????????
# ? Visual Studio ??????? F5

# 4. ?????????? ?????????:
# 
# LoginPage ???????????
#     ?
# ????????? GET /api/status
#     ?
# ????? mqtt_available = false
#     ?
# ?????????? ?????? "?? Guest Mode Available"
#     ?
# ????? 2 ??????? ?????????????:
#   • ????????????? credentials = guest
#   • ???????????? ????? SSE
#   • ????????? ?? DashboardPage
#     ?
# Dashboard ??????????:
#   "Connection: Connected (SSE) ?"
#   "Status: Online (SSE)"
#   + ???????? ?????? ? ?????????!
```

### ????????? ?????????:

```
??????????????????????????????????????
? Smart Home Login                   ?
??????????????????????????????????????
?                                    ?
?  ?? Guest Mode Available           ?
?  MQTT unavailable - using SSE      ?
?  Auto-connecting in 2 seconds...   ?
?                                    ?
?  [Username: ________]              ?
?  [Password: ________]              ?
?  [Login]                           ?
?                                    ?
?  Quick Login: [Guest] [Admin]      ?
??????????????????????????????????????

        ? (????? 2 ???)

??????????????????????????????????????
? Dashboard                          ?
??????????????????????????????????????
? Role: guest                        ?
? Status: Online (SSE)               ?
? Connection: Connected (SSE) ?     ?
?                                    ?
? Temperature: 22.5 °C               ?
? Humidity: 45%                      ?
? Power: 320 W                       ?
? Updated: 2024-01-15T14:30:00       ?
?                                    ?
? [Refresh]                          ?
? [Open Devices]                     ?
? [View Charts]                      ?
??????????????????????????????????????
```

---

### ???????? 2: ?????????? MQTT ?????

```bash
# 1. ????????? Mosquitto
mosquitto -c mosquitto.conf -v

# 2. ????????? FastAPI ??????
python main.py

# ?????? ?????? ??????:
# GET /api/status ? {"mqtt_available": true, ...}

# 3. ????????? MAUI ??????????

# 4. ?????????:
# • ?????? Guest Mode ?? ????????????
# • Auto-login ?? ??????????
# • ???????????? ?????? credentials ???????
# • ????? ?????? ???????????? ????? MQTT
# • Dashboard ?????????? "Connection: Connected (MQTT)"
```

---

## ?? Debug Output

??? ??????? ? Debug ?????? ?? ??????? ????:

```
LoginVm: InitializeAsync started
LoginVm: Checking server status...
LoginVm: Server returned mqtt_available=false, recommended=sse
LoginVm: Guest Mode available - showing banner
LoginVm: Auto-login will start in 2 seconds
...
LoginVm: Auto-logging in as guest (SSE mode)
RealtimeService: Starting...
RealtimeService: Server status - MQTT: False, Recommended: sse
RealtimeService: MQTT unavailable - using SSE fallback mode
SseService: Starting SSE connection...
SseService: Connecting to http://127.0.0.1:8000/api/events/stream
SseService: Connected ?
SseService: Event received - Topic: system/initial-state
DashboardVm: Realtime metrics received: 22.5°C (Mode: sse)
```

---

## ?? ????????? ??? ????????????

### ??????? ???????????? ????? ????????:

```csharp
// Services/AppSettings.cs

// ???????????? SSE (????????? MQTT ???????)
public static bool MqttUseTls
{
    get => false; // ????????????? SSE
    set => Preferences.Set(MqttUseTlsKey, value);
}

// ??? ???????? ???????? ??????? MQTT:
// Services/MqttService.cs
.WithTimeout(TimeSpan.FromSeconds(3)) // ??????? fallback ?? SSE
```

---

## ?? Checklist ????????????

- [ ] ????????? FastAPI ??? Mosquitto
- [ ] ????????? ??? `/api/status` ?????????? `mqtt_available: false`
- [ ] ????????? ??? `/api/events/stream` ???????? (SSE)
- [ ] ????????? MAUI ??????????
- [ ] ????????? ??? ?????????? ?????? "Guest Mode Available"
- [ ] ????????? 2 ???????
- [ ] ????????? ??? ????????? auto-login
- [ ] ????????? ??? Dashboard ?????????? ??????
- [ ] ????????? ??? Connection Status = "SSE"
- [ ] ????????? ??? ??????? ??????????? ? ???????? ???????

---

## ?? Troubleshooting

### ????????: Auto-login ?? ??????????

**?????????:**
1. Debug Output - ???? ?? `LoginVm: Auto-logging in as guest`?
2. `/api/status` endpoint ?????????
3. ?????????? ?? ?? `mqtt_available: false`?

**???????:**
```bash
# ????????? ?????? ???????
curl http://127.0.0.1:8000/api/status

# ?????? ???????:
{
  "mqtt_available": false,
  "recommended_mode": "sse",
  ...
}
```

### ????????: ?????? ?? ????????????

**?????????:**
- `ShowGuestModeInfo` property ?????????? ? `true`?
- `OnAppearing()` ???????????

**Debug:**
```csharp
// LoginVm.cs
public async Task InitializeAsync()
{
    System.Diagnostics.Debug.WriteLine("=== InitializeAsync CALLED ===");
    
    var status = await CheckServerStatusAsync();
    System.Diagnostics.Debug.WriteLine($"Server status: {status}");
    
    if (status != null && !status.MqttAvailable)
    {
        System.Diagnostics.Debug.WriteLine("Setting ShowGuestModeInfo = true");
        ShowGuestModeInfo = true;
    }
}
```

### ????????: SSE ?? ???????????? ????? auto-login

**?????????:**
1. FastAPI ?????? ????? `/api/events/stream` endpoint?
2. SSE stream ?????????? ????????

**Test:**
```bash
# ???? SSE ???????
curl -N http://127.0.0.1:8000/api/events/stream

# ?????? ??????????:
data: {"topic":"system/initial-state",...}
data: {"topic":"system/keepalive",...}
```

---

## ? ?????

### ?????? ????????:

? **?????????????? ???????????** ??????????? MQTT  
? **Auto-login ??? guest** ???? MQTT ??????????  
? **?????????? ?????????** Guest Mode  
? **Seamless UX** - ???????????? ????? ?????? ?????  
? **??? ??????? ?????????** - ?????? ???? ?????? ? ??????  

### ???????????????? ????:

**??????:**
```
LoginPage ? ???? credentials ? ?????? "Failed to connect" ?
```

**??????:**
```
LoginPage ? Auto-detect SSE ? Auto-login ? Dashboard ? ??????? ?
```

**????? ?? ??????:** `~2 ???????` ?????? `?` (?????????? ????)!

---

**????:** 2024-01-15  
**??????:** 1.1  
**??????:** ? **????????!**
