# ?? SSE Authentication - Quick Reference

## ??????? ?????? (Credentials)

### Development (Default)

| Role  | Username | Password   | Permissions |
|-------|----------|------------|-------------|
| Guest | `guest`  | `123`      | Read-only   |
| Admin | `admin`  | `admin123` | Full access |

### Production Setup

```bash
# ????????? ?????????? ?????????
export GUEST_PASSWORD="your-secure-guest-password"
export ADMIN_PASSWORD="your-secure-admin-password"

# ?????? ? HTTPS
uvicorn main:app --ssl-keyfile key.pem --ssl-certfile cert.pem --host 0.0.0.0 --port 8443
```

## API Endpoints

| Endpoint | Method | Guest | Admin | Description |
|----------|--------|-------|-------|-------------|
| `/api/metrics` | GET | ? | ? | ???????? ??????? |
| `/api/devices` | GET | ? | ? | ?????? ????????? |
| `/api/devices/{id}/toggle` | POST | ? 403 | ? | ??????????? ?????????? |
| `/api/events/stream` | GET | ? | ? | SSE ????? |
| `/api/status` | GET | ? | ? | ?????? ??????? |

## HTTP Status Codes

- **200 OK** - ???????? ??????
- **401 Unauthorized** - ???????? credentials ??? ??????????? ????????? Authorization
- **403 Forbidden** - ???????????? ???? (guest ???????? toggle)
- **404 Not Found** - ?????????? ?? ???????

## Curl Commands

### Metrics (Guest)
```bash
curl -u guest:123 http://127.0.0.1:8000/api/metrics
```

### Devices (Admin)
```bash
curl -u admin:admin123 http://127.0.0.1:8000/api/devices
```

### Toggle Device (Admin)
```bash
curl -u admin:admin123 -X POST http://127.0.0.1:8000/api/devices/lamp/toggle
```

### SSE Stream (Guest)
```bash
curl -u guest:123 -N http://127.0.0.1:8000/api/events/stream
```

### Test Unauthorized
```bash
# ??? credentials - ?????? ??????? 401
curl http://127.0.0.1:8000/api/metrics
```

### Test Forbidden
```bash
# Guest toggle - ?????? ??????? 403
curl -u guest:123 -X POST http://127.0.0.1:8000/api/devices/lamp/toggle
```

## Client Code Snippets

### C# - ApiClient
```csharp
// Credentials ??????????????? ??? ??????
AppSettings.MqttUsername = "guest";
AppSettings.MqttPassword = "123";

// ApiClient ????????????? ????????? Basic Auth
var metrics = await apiClient.GetMetricsAsync();
```

### C# - SseService
```csharp
// SSE ????????????? ?????????? credentials ?? AppSettings
await sseService.StartAsync();
// ???????????? ? Authorization: Basic <encoded-credentials>
```

### Python - Requests
```python
import requests
from requests.auth import HTTPBasicAuth

# API request
response = requests.get(
    'http://127.0.0.1:8000/api/metrics',
    auth=HTTPBasicAuth('guest', '123')
)
print(response.json())

# SSE stream
response = requests.get(
    'http://127.0.0.1:8000/api/events/stream',
    auth=HTTPBasicAuth('guest', '123'),
    stream=True
)
for line in response.iter_lines():
    if line:
        print(line.decode('utf-8'))
```

## Debug Output Examples

### ???????? ??????????? (Guest)
```
LoginVm: Attempting login as guest...
ApiClient: Basic Auth configured for user 'guest'
SseService: Using Basic Auth for user 'guest'
SseService: Connected
RealtimeService: SSE mode active
```

### ???????? credentials
```
ApiClient: Unauthorized (401) - check credentials
SseService: Unauthorized (401) - Invalid credentials
LoginVm: Login exception - Invalid credentials
```

### Guest ???????? toggle
```
DevicesVm: Toggling device 'lamp'...
ApiClient: ToggleDeviceAsync failed - User does not have permission to control devices
DevicesVm: Toggle failed - Access denied
```

## ????????? ????

### ???????? ??????
```
INFO:     127.0.0.1:64834 - "GET /api/metrics HTTP/1.1" 200 OK
```

### Unauthorized
```
INFO:     127.0.0.1:64834 - "GET /api/metrics HTTP/1.1" 401 Unauthorized
```

### Forbidden (Guest toggle)
```
INFO:     127.0.0.1:64834 - "POST /api/devices/lamp/toggle HTTP/1.1" 403 Forbidden
```

### SSE Connection
```
INFO:     127.0.0.1:64834 - "GET /api/events/stream HTTP/1.1" 200 OK
SSE client connected (user: guest, role: guest). Active clients: 1
```

## Common Issues

### ? 401 Everywhere
- **???????**: Credentials ?? ??????????? ??? ????????
- **???????**: ????????? `AppSettings.MqttUsername` ? `AppSettings.MqttPassword`

### ? 403 ?? Toggle
- **???????**: Guest ???????? ????????? ????????????
- **???????**: ??????? ??? admin

### ? SSE ?? ????????????
- **???????**: Credentials ?? ???????? ? SSE ???????
- **???????**: ?????????, ??? `AppSettings` ???????? username/password ????? `StartAsync()`

## Environment Variables Cheat Sheet

```bash
# Minimum setup (development)
export GUEST_PASSWORD="123"
export ADMIN_PASSWORD="admin123"

# Production setup
export GUEST_PASSWORD="$(openssl rand -base64 32)"
export ADMIN_PASSWORD="$(openssl rand -base64 32)"
export MQTT_HOST="mqtt.example.com"
export MQTT_PORT="8883"
export MQTT_USE_TLS="true"

# Run server
uvicorn main:app --host 0.0.0.0 --port 8000
```

## Testing Checklist

- [ ] Guest login works
- [ ] Admin login works
- [ ] Invalid credentials rejected (401)
- [ ] Guest can view metrics
- [ ] Guest can view devices
- [ ] Guest CANNOT toggle devices (403)
- [ ] Admin CAN toggle devices (200)
- [ ] SSE stream works for guest
- [ ] SSE stream works for admin
- [ ] Reconnection after disconnect

---

**Documentation**: See [SSE_AUTH_IMPLEMENTATION.md](SSE_AUTH_IMPLEMENTATION.md) for full details  
**Testing Guide**: See [SSE_AUTH_TESTING.md](SSE_AUTH_TESTING.md) for complete test scenarios
